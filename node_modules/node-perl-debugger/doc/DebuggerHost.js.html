<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: DebuggerHost.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: DebuggerHost.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

var events = require("events"),
    net = require("net");

var DebuggerCommands = require("./DebuggerCommands"),
    Logger = require("./logger");

module.exports = DebuggerHost;

DebuggerHost.CONNECTION_EVENT = "connection";
DebuggerHost.DISCONNECTION_EVENT = "disconnection";
DebuggerHost.LISTENING_EVENT = "listening";
DebuggerHost.CLOSE_EVENT = "close";

/**
 * @typedef {Object} DebuggerHostConfiguration
 * @property {string|Writable} log - If a string, path to a log file, else a Writable stream.
 * @property {int} port - The port to listen on.
 */

/**
 * A TCP based host that a Perl debugger can connect to.
 * &lt;p>
 * Emits the following events:
 * &lt;ul>
 *  &lt;li>connection - When a client connects to the TCP server.&lt;/li>
 *  &lt;li>disconnection - When a client disconnects from the TCP server.&lt;/li>
 *  &lt;li>listening - When the TCP server is ready for clients.&lt;/li>
 *  &lt;li>close - When the TCP server shuts down.&lt;/li>
 * &lt;/ul>
 * @param {DebuggerHostConfiguration} config
 * @constructor
 */
function DebuggerHost(config) {
  if (!config.port) {
    throw new Error("Can't start a DebuggerHost without a port");
  }

  this._config = config;
  this._logger = Logger.initLogger(config);

  this._emitter = new events.EventEmitter();
  this._commands = this._createTcpServer({
    log: this._logger.log
  });

  this._proxyServerEvents();
}

/**
 * Listen for events.
 * @param {string} event
 * @param {function} handler
 */
DebuggerHost.prototype.on = function(event, handler) {
  this._emitter.on(event, handler);
};

/**
 * Instruct the host to start listening for clients.
 * &lt;p>
 * Proxies net.Server.listen
 */
DebuggerHost.prototype.listen = function() {
  var port = this._config.port;

  this._server.listen(port);
  this._logger("Listening on port " + port);
};

/**
 * Instruct the host to stop listening for clients
 * &lt;p>
 * Proxies net.Server.close
 */
DebuggerHost.prototype.close = function() {
  this._server.close();
};

/**
 * @returns {DebuggerCommands} An interface for executing commands on the perl debugger.
 */
DebuggerHost.prototype.commands = function() {
  return this._commands;
};

DebuggerHost.prototype._createTcpServer = function(config) {
  var self = this,
      commands = new DebuggerCommands(null, config);

  this._server = net.createServer();

  this._server.on("connection", function(socket) {
    self._logger("Client connected");

    socket.setEncoding("utf8");
    commands.connect(socket);

    socket.on("end", function () {
      self._logger("Client disconnected");

      self._emitter.emit(DebuggerHost.DISCONNECTION_EVENT);
    });

    if (self._logger.log) {
      socket.pipe(self._logger.log);
    }

    self._emitter.emit(DebuggerHost.CONNECTION_EVENT);
  });

  return commands;
};

DebuggerHost.prototype._proxyServerEvents = function() {
  var self = this;

  [ DebuggerHost.LISTENING_EVENT, DebuggerHost.CLOSE_EVENT ].forEach(function(event) {
    self._server.on(event, function() {
      self._emitter.emit(event);
    });
  });
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DebuggerCommands.html">DebuggerCommands</a></li><li><a href="DebuggerHost.html">DebuggerHost</a></li><li><a href="DebuggerParser.html">DebuggerParser</a></li><li><a href="DebuggerStackTraceParser.html">DebuggerStackTraceParser</a></li><li><a href="DebuggerVariableParser.html">DebuggerVariableParser</a></li><li><a href="Parser.html">Parser</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Wed Aug 19 2015 23:31:27 GMT+1000 (AEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
